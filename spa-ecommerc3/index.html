<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SPA Shop â€” Catalog, Detail, Cart</title>
  <style>
    /* Color tokens (design system) */
    :root{
      --bg: #f6f7fb;
      --surface: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #e5e7eb;

      --brand-50: #eef2ff;
      --brand-100: #e0e7ff;
      --brand-200: #c7d2fe;
      --brand-500: #3b82f6;
      --brand-700: #2563eb;
      --brand-900: #1e40af;

      --accent: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 6px 18px rgba(0,0,0,.08);
    }

    * { box-sizing: border-box; }
    html, body, #root { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: var(--text);
    }

    /* Layout shell */
    .app {
      display: grid;
      grid-template-columns: 280px 1fr 360px;
      gap: 16px;
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Header */
    header {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 5;
    }
    .brand {
      display: flex; align-items: center; gap: 12px;
    }
    .brand .logo {
      width: 38px; height: 38px; border-radius: 9px;
      display: inline-flex; align-items: center; justify-content: center;
      background: linear-gradient(135deg, var(--brand-500), var(--brand-700));
      color: white; font-weight: 700;
    }
    .brand h1 { font-size: 1.1rem; margin: 0; }

    .search {
      display: flex; align-items: center; gap: 8px;
      flex: 1; max-width: 520px;
      background: #fff; border: 1px solid var(--border); border-radius: 999px;
      padding: 6px 12px;
    }
    .search input {
      border: none; outline: none; width: 100%; font-size: 0.95rem;
      background: transparent;
    }
    .btn {
      border: 0; border-radius: 8px; padding: 10px 14px;
      cursor: pointer; font-weight: 600;
      background: var(--brand-500); color: white;
    }
    .btn.secondary {
      background: #fff; color: var(--text); border: 1px solid var(--border);
    }

    /* Responsive helpers */
    @media (max-width: 1024px){
      .app { grid-template-columns: 1fr 1fr; }
      .filters { display: none; } /* collapsible on smaller screens; toggled by JS if desired */
      .cart-panel { width: 100%; height: 50vh; }
    }
    @media (max-width: 720px){
      .app { grid-template-columns: 1fr; padding: 8px; }
      header { position: sticky; top: 0; }
    }

    /* Panels */
    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: var(--shadow);
      min-height: 60px;
    }

    .filters {
      display: flex; flex-direction: column; gap: 12px;
    }
    .filters h3 { margin: 0 0 6px 0; font-size: 0.95rem; color: var(--muted); }

    .section {
      padding: 8px; border-radius: 8px; border: 1px solid var(--border);
      background: #fff;
    }

    .category-list { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip {
      padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border);
      background: #fff; cursor: pointer; font-size: 0.85rem;
    }
    .chip.active { background: var(--brand-500); color: #fff; border-color: transparent; }

    .range-row { display: flex; align-items: center; gap: 8px; justify-content: space-between; }
    .range-row input[type="range"] { width: 100%; }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      gap: 14px;
    }

    .card {
      border: 1px solid var(--border); border-radius: 12px; overflow: hidden;
      display: flex; flex-direction: column; background: #fff;
      transition: transform .2s;
    }
    .card:hover { transform: translateY(-2px); }
    .card-img {
      height: 140px; background: #f6f6f6; display: grid; place-items: center;
    }
    .card-img img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .card-content { padding: 10px; display: flex; flex-direction: column; gap: 6px; }
    .card-title { font-weight: 600; font-size: 0.95rem; line-height: 1.25; }
    .price { font-weight: 700; color: var(--brand-900); }
    .stock { font-size: 0.85rem; color: var(--muted); }
    .card-actions { display: flex; align-items: center; justify-content: space-between; gap: 6px; padding-top: 6px; }

    .icon-btn { border: 1px solid var(--border); background: #fff; border-radius: 8px; padding: 8px 10px; cursor: pointer; }
    .icon-btn.primary { background: var(--brand-500); color: #fff; border-color: transparent; }
    .icon-btn:focus { outline: 2px solid var(--brand-500); outline-offset: 2px; }

    /* Drawers (right side) */
    .drawer {
      position: fixed; top: 0; right: -100%; height: 100%; width: 360px;
      background: #fff; border-left: 1px solid var(--border);
      box-shadow: -6px 0 20px rgba(0,0,0,.08);
      transition: right .25s ease;
      z-index: 50;
      display: flex; flex-direction: column;
    }
    .drawer.open { right: 0; }
    .drawer-header { padding: 12px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .drawer-content { padding: 12px; overflow: auto; min-height: 200px; }

    .divider { height: 1px; background: var(--border); margin: 6px 0; }

    /* Product detail layout inside drawer */
    .detail-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .detail-img { height: 180px; background: #f6f6f6; display: grid; place-items: center; border-radius: 8px; }
    .detail-title { font-size: 1.1rem; font-weight: 700; margin: 0; }
    .detail-desc { color: var(--muted); font-size: 0.95rem; }

    .qty { display: inline-flex; align-items: center; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
    .qty button { background: #fff; border: none; padding: 6px 10px; cursor: pointer; }
    .qty input { width: 48px; text-align: center; border: none; padding: 6px; }

    .checkout {
      padding: 12px; border-top: 1px solid var(--border); margin-top: auto;
      display: flex; flex-direction: column; gap: 8px;
    }
    .summary { display:flex; justify-content: space-between; font-weight:600; padding: 2px 0; }
    .cta { width: 100%; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700;
           background: var(--brand-700); color: #fff; }
    .cta.ghost { background: #fff; border: 1px solid var(--border); color: var(--text); }

    /* Cart aside (another drawer) - reuse drawer with a class toggle */
    .drag-handle { width: 28px; height: 4px; background: var(--border); border-radius: 4px; margin: 6px auto; }

    /* Empty state styles */
    .empty { text-align: center; color: var(--muted); padding: 20px; }

    /* Helper utilities */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
  </style>
</head>
<body>
  <div class="app" id="app-root" aria-label="Shop SPA">
    <header role="banner" aria-label="Site header">
      <div class="brand" aria-label="Brand">
        <div class="logo" aria-label="Brand logo">S</div>
        <h1>ShopSphere</h1>
      </div>

      <div class="search" role="search" aria-label="Product search">
        <span aria-hidden="true">ðŸ”Ž</span>
        <input id="searchBox" type="search" placeholder="Search products..." />
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn secondary" id="toggleFilters" title="Show filters (mobile)">Filters</button>
        <button class="btn" id="openCart" aria-label="Open cart">Cart</button>
      </div>
    </header>

    <!-- Left filters panel -->
    <aside class="panel filters" aria-label="Product filters" id="filtersPanel">
      <div class="section" aria-label="Categories">
        <h3>Categories</h3>
        <div class="category-list" id="categoryList"></div>
      </div>

      <div class="section" aria-label="Price filter">
        <h3>Price</h3>
        <div class="range-row" style="align-items:center;">
          <span>Min</span>
          <input id="minPrice" type="range" min="0" max="1000" step="1" value="0" />
          <span id="minPriceVal">$0</span>
        </div>
        <div class="range-row" style="align-items:center;">
          <span>Max</span>
          <input id="maxPrice" type="range" min="0" max="1000" step="1" value="1000" />
          <span id="maxPriceVal">$1000</span>
        </div>
      </div>

      <div class="section" aria-label="Rating filter">
        <h3>Min Rating</h3>
        <div class="range-row" style="gap:6px;">
          <span>0</span>
          <input id="minRating" type="range" min="0" max="5" step="0.5" value="0" />
          <span>5</span>
        </div>
        <div id="ratingDisplay" aria-live="polite" style="margin-top:6px; font-size:.9rem;"></div>
      </div>

      <div class="section" aria-label="Sorting">
        <h3>Sort by</h3>
        <select id="sortSelect" style="width:100%; padding:8px; border-radius:6px; border:1px solid var(--border);">
          <option value="relevance">Relevance</option>
          <option value="price-asc">Price: Low to High</option>
          <option value="price-desc">Price: High to Low</option>
          <option value="rating-desc">Rating: High to Low</option>
          <option value="name-asc">Name: A to Z</option>
        </select>
      </div>
      <div class="section" aria-label="Clear filters">
        <button class="btn" id="clearFilters" style="width:100%;">Clear Filters</button>
      </div>
    </aside>

    <!-- Catalog -->
    <section class="panel" aria-label="Product catalog" style="min-height:300px;">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
        <strong>Catalog</strong>
        <span id="resultCount" aria-live="polite" style="color:var(--muted); font-size:.9rem;"></span>
      </div>
      <div class="card-grid" id="productGrid" role="region" aria-label="Product catalog grid">
        <!-- Cards injected by JS -->
      </div>
      <div id="emptyState" class="empty" style="display:none;">No products match your filters.</div>
    </section>

    <!-- Right drawer: Product Detail (slides in) -->
    <aside class="drawer" id="detailDrawer" aria-label="Product detail panel" aria-hidden="true">
      <div class="drawer-header">
        <strong>Product Detail</strong>
        <button class="icon-btn" id="closeDetail" aria-label="Close detail">âœ•</button>
      </div>
      <div class="drawer-content" id="detailContent">
        <!-- Detail content injected by JS -->
      </div>
      <div class="checkout" aria-label="Detail actions">
        <div class="divider"></div>
        <button class="cta" id="detailAddToCart" disabled>Add to Cart</button>
      </div>
    </aside>

    <!-- Right drawer: Cart (slides in) -->
    <aside class="drawer" id="cartDrawer" aria-label="Shopping cart panel" aria-hidden="true">
      <div class="drawer-header">
        <strong>Your Cart</strong>
        <button class="icon-btn" id="closeCart" aria-label="Close cart">âœ•</button>
      </div>
      <div class="drawer-content" id="cartContent">
        <!-- Cart items injected by JS -->
      </div>
      <div class="checkout" aria-label="Cart totals">
        <div class="summary" id="cartSubtotal"><span>Subtotal</span><span>$0</span></div>
        <div class="summary" id="cartShipping" style="display:none;"><span>Shipping</span><span>Free</span></div>
        <div class="summary" id="cartTotal" style="font-size:1.05em;"><span>Total</span><span>$0</span></div>
        <button class="cta" id="checkoutBtn" aria-label="Proceed to checkout">Checkout</button>
        <button class="cta ghost" id="clearCartBtn" aria-label="Clear cart" style="margin-top:6px;">Clear Cart</button>
      </div>
    </aside>
  </div>

  <script>
    // Data model (mock products)
    const products = [
      {
        id: 101,
        name: "Aurora Wireless Headphones",
        description: "Immersive sound with 40h battery life and plush cushioning for all-day comfort.",
        price: 149.99,
        category: "Electronics",
        rating: 4.5,
        stock: 12,
        image: makeImg("Aurora Headphones", "#3b82f6", "#8b5cf6")
      },
      {
        id: 102,
        name: "Nimbus Mechanical Keyboard",
        description: "Tactile, clicky keys with hot-swappable switches and RGB backlighting.",
        price: 89.0,
        category: "Electronics",
        rating: 4.7,
        stock: 5,
        image: makeImg("Nimbus Keyboard", "#10b981", "#0ea5e9")
      },
      {
        id: 103,
        name: "Luma Smart Lamp",
        description: "Voice-controlled ambient lighting with scenes and sunset timer.",
        price: 39.99,
        category: "Home",
        rating: 4.2,
        stock: 25,
        image: makeImg("Luma Lamp", "#f59e0b", "#f472b6")
      },
      {
        id: 104,
        name: "Piper Ceramic Mug Set",
        description: "Dishwasher-safe stoneware mugs, set of 4 with matte glaze.",
        price: 24.0,
        category: "Kitchen",
        rating: 4.0,
        stock: 0,
        image: makeImg("Mug Set", "#f87171", "#f472b6")
      },
      {
        id: 105,
        name: "TrailRunner Sneakers",
        description: "Lightweight trail sneakers with responsive foam and grippy outsole.",
        price: 74.5,
        category: "Apparel",
        rating: 4.3,
        stock: 18,
        image: makeImg("TrailRunner Shoes", "#34d399", "#3b82f6")
      },
      {
        id: 106,
        name: "Nova USB-C Hub",
        description: "6-in-1 USB-C hub with HDMI, SD, USB-A and power delivery.",
        price: 29.99,
        category: "Electronics",
        rating: 4.1,
        stock: 9,
        image: makeImg("Nova Hub", "#8b5cf6", "#22c55e")
      },
      {
        id: 107,
        name: "Cascade Coffee Grinder",
        description: "Conical burr grinder with precise grind settings for French press to espresso.",
        price: 59.99,
        category: "Home",
        rating: 4.6,
        stock: 3,
        image: makeImg("Cascade Grinder", "#f472b6", "#f59e0b")
      },
      {
        id: 108,
        name: "Sierra Travel Backpack",
        description: "Carry-on size backpack with padded laptop sleeve and water-resistant shell.",
        price: 64.99,
        category: "Accessories",
        rating: 4.4,
        stock: 7,
        image: makeImg("Sierra Backpack", "#34d399", "#3b82f6")
      }
    ];

    // Simple SVG-based placeholder image generator
    function makeImg(label, c1, c2){
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="600" height="400">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop stop-color="${c1}" offset="0"/>
              <stop stop-color="${c2}" offset="1"/>
            </linearGradient>
          </defs>
          <rect width="100%" height="100%" fill="url(#g)"/>
          <text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="40" fill="white">${label}</text>
        </svg>`;
      return "data:image/svg+xml;utf8," + encodeURIComponent(svg);
    }

    // State
    let cart = [];
    let detailProductId = null;
    let isCartOpen = false;
    let isDetailOpen = false;

    // DOM refs
    const productGrid = document.getElementById('productGrid');
    const resultCount = document.getElementById('resultCount');
    const emptyState = document.getElementById('emptyState');
    const searchBox = document.getElementById('searchBox');
    const categoryList = document.getElementById('categoryList');
    const minPrice = document.getElementById('minPrice');
    const maxPrice = document.getElementById('maxPrice');
    const minRating = document.getElementById('minRating');
    const ratingDisplay = document.getElementById('ratingDisplay');
    const sortSelect = document.getElementById('sortSelect');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const detailDrawer = document.getElementById('detailDrawer');
    const detailContent = document.getElementById('detailContent');
    const detailAddToCartBtn = document.getElementById('detailAddToCart');
    const closeDetailBtn = document.getElementById('closeDetail');
    const openCartBtn = document.getElementById('openCart');
    const cartDrawer = document.getElementById('cartDrawer');
    const cartContent = document.getElementById('cartContent');
    const closeCartBtn = document.getElementById('closeCart');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const clearCartBtn = document.getElementById('clearCartBtn');
    const cartSubtotal = document.getElementById('cartSubtotal');
    const cartTotal = document.getElementById('cartTotal');
    const cartShipping = document.getElementById('cartShipping');

    // Helpers
    function saveCart(){
      try { localStorage.setItem('spa_cart', JSON.stringify(cart)); } catch(e){}
    }
    function loadCart(){
      try {
        const s = localStorage.getItem('spa_cart');
        if (s) cart = JSON.parse(s);
      } catch(e){}
    }
    function openDrawer(drawer){
      drawer.classList.add('open');
      drawer.setAttribute('aria-hidden', 'false');
    }
    function closeDrawer(drawer){
      drawer.classList.remove('open');
      drawer.setAttribute('aria-hidden', 'true');
    }

    // Init category chips
    function initCategories(){
      const cats = Array.from(new Set(products.map(p => p.category)));
      categoryList.innerHTML = '';
      const all = document.createElement('button');
      all.className = 'chip active';
      all.textContent = 'All';
      all.addEventListener('click', ()=> { currentFilter.category = 'All'; render(); highlightActiveChip('All') });
      categoryList.appendChild(all);
      cats.forEach(cat => {
        const chip = document.createElement('button');
        chip.className = 'chip';
        chip.textContent = cat;
        chip.addEventListener('click', ()=> { currentFilter.category = cat; render(); highlightActiveChip(cat) });
        categoryList.appendChild(chip);
      });
    }

    // Highlight active category chip
    function highlightActiveChip(active){
      [...categoryList.children].forEach(ch => ch.classList.remove('active'));
      for (let ch of categoryList.children){
        if (ch.textContent === active){
          ch.classList.add('active');
          break;
        }
        if (active === 'All' && ch.textContent === 'All'){
          ch.classList.add('active');
        }
      }
    }

    // Current filter state
    const currentFilter = {
      query: '',
      category: 'All',
      min: 0,
      max: 1000,
      minRating: 0,
      sort: 'relevance'
    };

    // Apply filters and render catalog
    function getFiltered(){
      let list = products.filter(p => {
        // category
        if (currentFilter.category !== 'All' && p.category !== currentFilter.category) return false;
        // search
        const q = currentFilter.query?.toLowerCase() ?? '';
        if (q && !(p.name.toLowerCase().includes(q) || p.description.toLowerCase().includes(q))) return false;
        // price
        if (p.price < currentFilter.min || p.price > currentFilter.max) return false;
        // rating
        if (p.rating < currentFilter.minRating) return false;
        return true;
      });
      // sort
      switch(currentFilter.sort){
        case 'price-asc':
          list.sort((a,b)=> a.price - b.price); break;
        case 'price-desc':
          list.sort((a,b)=> b.price - a.price); break;
        case 'rating-desc':
          list.sort((a,b)=> b.rating - a.rating); break;
        case 'name-asc':
          list.sort((a,b)=> a.name.localeCompare(b.name)); break;
        default:
          // relevance: basic by rating then price
          list.sort((a,b)=> (b.rating - a.rating) || (a.price - b.price));
      }
      return list;
    }

    function renderProducts(){
      const list = getFiltered();
      productGrid.innerHTML = '';
      if (!list.length){
        emptyState.style.display = 'block';
        resultCount.textContent = '0 results';
        return;
      } else {
        emptyState.style.display = 'none';
      }
      list.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-img" role="img" aria-label="${p.name}">
            <img src="${p.image}" alt="${p.name}" width="100%" height="100%">
          </div>
          <div class="card-content">
            <div class="card-title" style="display:flex; justify-content:space-between; align-items:center;">
              <span>${p.name}</span>
              <span class="price">$${p.price.toFixed(2)}</span>
            </div>
            <div style="color:var(--muted); font-size:.85rem; display:flex; justify-content:space-between; align-items:center;">
              <span>${p.category}</span>
              <span>${'â˜…'.repeat(Math.floor(p.rating))}${p.rating%1>=0.5 ? 'Â½' : ''}</span>
            </div>
            <div class="stock" aria-label="${p.stock > 0 ? 'In stock' : 'Out of stock'}">
              ${p.stock > 0 ? p.stock + ' in stock' : 'Out of stock'}
            </div>
            <div class="card-actions">
              <button class="icon-btn" aria-label="View details" data-id="${p.id}">Details</button>
              <button class="icon-btn primary" ${p.stock<=0?'disabled':''} aria-label="Add to cart" data-id="${p.id}">Add to cart</button>
            </div>
          </div>
        `;
        // Event listeners
        card.querySelector('[aria-label="View details"]').addEventListener('click', (ev) => {
          ev.stopPropagation();
          openDetail(p.id);
        });
        card.querySelector('[aria-label="Add to cart"]').addEventListener('click', (ev) => {
          ev.stopPropagation();
          addToCart(p.id, 1);
        });
        productGrid.appendChild(card);
      });
      resultCount.textContent = list.length + ' results';
    }

    // Detail drawer handling
    function openDetail(pid){
      detailProductId = pid;
      const p = products.find(x => x.id === pid);
      if (!p) return;
      detailContent.innerHTML = `
        <div class="detail-row">
          <div class="detail-img" style="min-height:180px;">
            <img src="${p.image}" alt="${p.name}" style="width:100%; height:100%; object-fit:cover;">
          </div>
          <div style="display:flex; flex-direction:column; gap:6px;">
            <h3 class="detail-title">${p.name}</h3>
            <div style="color:var(--muted); font-size:.9rem;">${p.category} â€¢ ${p.stock>0?p.stock+' in stock':'Out of stock'}</div>
            <div style="font-weight:700; font-size:1.2rem; color:var(--brand-900)">$${p.price.toFixed(2)}</div>
            <div class="detail-desc" style="font-size:.92rem; line-height:1.5;">${p.description}</div>
            <div style="margin-top:auto; display:flex; gap:8px; align-items:center;">
              <span>Rating: ${p.rating} / 5</span>
            </div>
          </div>
        </div>
      `;
      // enable add to cart button
      detailAddToCartBtn.disabled = p.stock <= 0;
      detailAddToCartBtn.textContent = 'Add to Cart';
      detailAddToCartBtn.onclick = () => { addToCart(p.id, 1); };
      openDrawer(detailDrawer);
      isDetailOpen = true;
    }

    // Add to cart (idempotent increments)
    function addToCart(productId, qty){
      const p = products.find(x => x.id === productId);
      if (!p) return;
      const existing = cart.find(ci => ci.productId === productId);
      const maxAdd = p.stock;
      if (existing){
        const newQty = Math.min(existing.quantity + qty, maxAdd);
        existing.quantity = newQty;
      } else {
        cart.push({ productId, quantity: Math.min(qty, maxAdd) });
      }
      saveCart();
      renderCart();
    }

    // Cart render
    function renderCart(){
      cartContent.innerHTML = '';
      if (cart.length === 0){
        cartContent.innerHTML = '<div class="empty">Your cart is empty. Add items to get started.</div>';
        cartSubtotal.innerHTML = '<span>Subtotal</span><span>$0.00</span>';
        cartTotal.querySelector('span:last-child').textContent = '$0.00';
        cartShipping.style.display = 'none';
        return;
      }
      let subtotal = 0;
      cart.forEach(item => {
        const prod = products.find(p => p.id === item.productId);
        if (!prod) return;
        const line = document.createElement('div');
        line.style.display = 'flex'; line.style.alignItems = 'center'; line.style.justifyContent = 'space-between';
        line.style.gap = '8px'; line.style.padding = '8px 0;'; line.style.borderBottom = '1px solid var(--border)';
        line.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px;">
            <img src="${prod.image}" alt="${prod.name}" style="width:40px; height:40px; object-fit:cover; border-radius:6px;" />
            <div style="min-width:0;">
              <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:180px;">${prod.name}</div>
              <div style="font-size:.85rem; color:var(--muted)">${prod.category}</div>
            </div>
          </div>
          <div style="display:flex; align-items: center; gap:6px;">
            <span>$${prod.price.toFixed(2)}</span>
            <div class="qty" aria-label="Quantity for ${prod.name}">
              <button data-action="dec" data-id="${prod.id}">âˆ’</button>
              <input aria-label="Quantity" type="text" data-id="${prod.id}" value="${item.quantity}" readonly/>
              <button data-action="inc" data-id="${prod.id}">ï¼‹</button>
            </div>
            <button class="icon-btn" aria-label="Remove item" data-id="${prod.id}">ðŸ—‘</button>
          </div>
        `;
        cartContent.appendChild(line);

        // Attach handlers
        line.querySelectorAll('button[data-action]').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = parseInt(btn.getAttribute('data-id'), 10);
            const action = btn.getAttribute('data-action');
            if (action === 'inc') updateCartQty(id, 1);
            if (action === 'dec') updateCartQty(id, -1);
          });
        });
        line.querySelectorAll('button[data-id]').forEach(remBtn => {
          remBtn.addEventListener('click', () => {
            const id = parseInt(remBtn.getAttribute('data-id'), 10);
            removeFromCart(id);
          });
        });

        subtotal += prod.price * item.quantity;
      });

      cartSubtotal.innerHTML = `<span>Subtotal</span><span>$${subtotal.toFixed(2)}</span>`;
      const shippingTick = subtotal > 0 ? 0 : 0;
      if (shippingTick === 0 && subtotal > 0){
        cartShipping.style.display = 'flex';
      } else {
        cartShipping.style.display = 'none';
      }
      const total = subtotal;
      cartTotal.innerHTML = `<span>Total</span><span>$${total.toFixed(2)}</span>`;
    }

    function updateCartQty(productId, delta){
      const item = cart.find(ci => ci.productId === productId);
      if (!item) return;
      item.quantity = Math.max(0, item.quantity + delta);
      if (item.quantity === 0){
        cart = cart.filter(ci => ci.productId !== productId);
      } else {
        // respect stock
        const prod = products.find(p => p.id === productId);
        if (prod) item.quantity = Math.min(item.quantity, prod.stock);
      }
      saveCart();
      renderCart();
    }

    function removeFromCart(productId){
      cart = cart.filter(ci => ci.productId !== productId);
      saveCart();
      renderCart();
    }

    // Checkout flow (simulated)
    function simulateCheckout(){
      // simple modal-like confirmation using alert for simplicity
      const email = "customer@example.test";
      // reset cart
      cart = [];
      saveCart();
      renderCart();
      alert("Checkout complete. This is a simulated flow. No payment is processed. Thank you!");
    }

    // Bind events
    function bindEvents(){
      // live search
      searchBox.addEventListener('input', (e) => {
        currentFilter.query = e.target.value;
        render();
      });

      minPrice.addEventListener('input', () => {
        currentFilter.min = Number(minPrice.value);
        document.getElementById('minPriceVal').textContent = "$" + Number(minPrice.value);
        render();
      });
      maxPrice.addEventListener('input', () => {
        currentFilter.max = Number(maxPrice.value);
        document.getElementById('maxPriceVal').textContent = "$" + Number(maxPrice.value);
        render();
      });
      minRating.addEventListener('input', () => {
        currentFilter.minRating = Number(minRating.value);
        ratingDisplay.textContent = "Min rating: " + currentFilter.minRating;
        render();
      });
      sortSelect.addEventListener('change', ()=> { currentFilter.sort = sortSelect.value; render(); });

      // Clear filters
      clearFiltersBtn.addEventListener('click', ()=> {
        currentFilter.query = '';
        currentFilter.category = 'All';
        currentFilter.min = 0;
        currentFilter.max = 1000;
        currentFilter.minRating = 0;
        sortSelect.value = 'relevance';
        searchBox.value = '';
        minPrice.value = 0; maxPrice.value = 1000; minRating.value = 0;
        document.getElementById('minPriceVal').textContent = '$0';
        document.getElementById('maxPriceVal').textContent = '$1000';
        ratingDisplay.textContent = 'Min rating: 0';
        highlightActiveChip('All');
        render();
      });

      // Drawer closes
      closeDetailBtn.addEventListener('click', ()=> { closeDrawer(detailDrawer); isDetailOpen = false; });
      closeCartBtn.addEventListener('click', ()=> { closeDrawer(cartDrawer); isCartOpen = false; });

      // Open cart from header
      openCartBtn.addEventListener('click', ()=> {
        if (isCartOpen){
          closeDrawer(cartDrawer);
          isCartOpen = false;
        } else {
          renderCart();
          openDrawer(cartDrawer);
          isCartOpen = true;
        }
      });

      // Checkout
      checkoutBtn.addEventListener('click', ()=> {
        if (cart.length === 0){
          alert("Your cart is empty.");
          return;
        }
        simulateCheckout();
        closeDrawer(cartDrawer);
        isCartOpen = false;
      });

      // Clear cart
      clearCartBtn.addEventListener('click', ()=> {
        if (confirm("Clear all items from cart?")) {
          cart = [];
          saveCart();
          renderCart();
        }
      });

      // Detach click on document to close drawers when clicking outside (simple UX)
      document.addEventListener('click', (e) => {
        if (!detailDrawer.contains(e.target) && !e.target.closest('[aria-label="Product detail panel"]')) {
          // do nothing for simplicity
        }
      });

      // Initialize
      initCategories();
      render();
    }

    // Render all
    function render(){
      // update filter summary
      renderProducts();
      // if detail/drawer should be opened/closed based on state (not required on render)
      // Keep current simple behavior
    }

    // Initialize: load cart, bind events
    loadCart();
    bindEvents();

  </script>
</body>
</html>