<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoFlow Dealer Showroom</title>
  <style>
    /* Basic reset and palette */
    :root{
      --bg: #0b0724;
      --bg2: #1a0a4a;
      --card: #141226;
      --card-2: #1f1a32;
      --text: #f5f5f7;
      --muted: #b8b8c8;
      --accent: #8b5cf6;
      --accent2: #5b2ab6;
      --green: #34d399;
      --red: #f87171;
    }
    *,*:before,*:after{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Arial;
      color: var(--text);
      background: linear-gradient(135deg, #1a0a4a 0%, #3b1f87 50%, #1a0a4a 100%);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a{ color: inherit; text-decoration: none; }

    /* Layout */
    header{ padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(135deg, rgba(138, 54, 255, .25), rgba(98,0,238,.15) 60%, rgba(0,0,0,.0));
      position: sticky; top:0; z-index: 10;
    }
    header h1{ margin:0; font-size: 1.25rem; display:flex; align-items:center; gap:8px; }
    .layout{ display:flex; height: calc(100vh - 72px); overflow: hidden; }
    aside.filters{ width:320px; padding: 16px; overflow:auto; border-right:1px solid rgba(255,255,255,.08);
      background: rgba(15,8,40,.6); backdrop-filter: blur(4px);
    }
    main.content{ flex:1; padding: 16px; overflow:auto; }

    /* Admin panel (two tabs) */
    .admin-panel{ margin: 0; padding: 0 8px 16px; border-top:1px solid rgba(255,255,255,.08); }
    .tabs{ display:flex; gap:8px; margin: 8px 0 12px; }
    .tabs button{ background: #2b1740; color:#fff; border:1px solid rgba(255,255,255,.15);
      padding:8px 12px; border-radius:8px; cursor:pointer;
    }
    .tabs button[aria-selected="true"]{ background: #5b2ab6; outline:2px solid #7c5cff; }
    .tab-content{ padding:12px; border:1px solid rgba(255,255,255,.15); border-radius:10px; background: rgba(8,6,22,.6); margin-bottom:12px; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:14px; }
    .card{ background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.15);
      border-radius:12px; overflow:hidden; display:flex; flex-direction:column; min-width:0;
    }
    .card-media{ position:relative; height:180px; background:#111; display:block; overflow:hidden; }
    .skeleton{ position:absolute; inset:0; background: linear-gradient(90deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.12) 20%, rgba(255,255,255,.06) 40%); background-size: 200% 100%;
      animation: pulse 1.2s linear infinite;
    }
    @keyframes pulse{ 0%{ background-position: 200% 0; } 100%{ background-position: -200% 0; } }
    .car-img{ width:100%; height:100%; object-fit:cover; display:block; opacity:0; transition: opacity .6s ease; }
    .emoji{ position:absolute; font-size:48px; left:50%; top:50%; transform: translate(-50%, -50%); filter: drop-shadow(0 4px 8px rgba(0,0,0,.4)); }
    .card-body{ padding:10px 12px 14px; display:flex; flex-direction:column; gap:6px; }
    .car-title{ margin:0; font-size:1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .label{ font-size:.8rem; color:var(--muted); }
    .row{ display:flex; justify-content: space-between; align-items:center; gap:8px; }
    .btn{ padding:6px 10px; border-radius:6px; border:1px solid rgba(255,255,255,.2); background:#2a1748; color:#fff; cursor:pointer; }
    .btn.primary{ background: #7c5cff; border-color:#7c5cff; }
    .btn.danger{ background:#3a0f2b; border-color:#7a203b; }
    .btn.ghost{ background:transparent; border-color: rgba(255,255,255,.25); }

    /* Filter panel */
    .filter-section{ display:flex; flex-direction:column; gap:12px; }
    .filter-section h2{ margin:0 0 6px; font-size:1.05rem; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size:.85rem; color:#ddd; }
    .field input, .field select{ padding:8px 10px; border-radius:6px; border:1px solid #333; background:#0b0a1a; color:#fff; }
    .field input[type="range"]{ width:100%; }

    /* Showroom header */
    .toolbar{ display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .toolbar h1{ font-size:1.2rem; margin:0; }
    #search{ padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.25); min-width:240px; background:#0b0a1a; color:#fff; }
    .toast{ position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); background: #111; color:#fff; padding:12px 16px; border-radius:8px; border:1px solid rgba(255,255,255,.2); display:none; z-index: 50; }

    /* Modal for details (basic trap) */
    .modal{ position: fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,.6); visibility:hidden; opacity:0; transition: opacity .2s; }
    .modal[aria-hidden="false"]{ visibility:visible; opacity:1; }
    .modal-content{ width: min(90vw, 720px); background:#0b0a1a; border:1px solid rgba(255,255,255,.25); border-radius:10px; padding:14px; }
    .modal-close{ float:right; border:0; background:transparent; color:#fff; font-size:20px; cursor:pointer; }
    .modal-body img{ width:100%; height:auto; display:block; border-radius:6px; margin-bottom:8px; }

    /* Responsive tweaks */
    @media (max-width: 1024px){
      aside.filters{ display:none; }
      .layout{ height: auto; }
    }

    /* Accessibility helpers */
    [role="group"]{ display:inline-flex; gap:6px; align-items:center; }
  </style>
</head>
<body>
  <header aria-label="Site header">
    <h1>ðŸŽ¯ AutoFlow Dealer Showroom</h1>
  </header>

  <div class="layout" role="main">
    <!-- Filter panel -->
    <aside class="filters" aria-label="Car filters">
      <section class="filter-section" aria-label="Car filters">
        <h2>Filters</h2>
        <div class="field">
          <label for="filter-search-global">Search</label>
          <input id="filter-search-global" type="text" placeholder="Search cars, makes, colorsâ€¦" />
        </div>
        <div class="field">
          <label for="filter-make">Make</label>
          <select id="filter-make">
            <option value="">Any</option>
          </select>
        </div>
        <div class="field">
          <label for="filter-model">Model</label>
          <select id="filter-model">
            <option value="">Any</option>
          </select>
        </div>
        <div class="field">
          <label for="filter-body">Body Type</label>
          <select id="filter-body">
            <option value="">Any</option>
            <!-- filled dynamically -->
          </select>
        </div>
        <div class="field">
          <label for="filter-fuel">Fuel</label>
          <select id="filter-fuel">
            <option value="">Any</option>
          </select>
        </div>
        <div class="field">
          <label for="filter-trans">Transmission</label>
          <select id="filter-trans">
            <option value="">Any</option>
          </select>
        </div>
        <div class="field">
          <label for="filter-color">Color</label>
          <input id="filter-color" type="text" placeholder="e.g., Red" />
        </div>
        <div class="field">
          <label>Price range</label>
          <div style="display:flex; gap:6px;">
            <input id="filter-minPrice" type="number" placeholder="Min" style="flex:1;" />
            <input id="filter-maxPrice" type="number" placeholder="Max" style="flex:1;" />
          </div>
        </div>
        <div class="field">
          <label>Year range</label>
          <div style="display:flex; gap:6px;">
            <input id="filter-minYear" type="number" placeholder="Min year" style="flex:1;" />
            <input id="filter-maxYear" type="number" placeholder="Max year" style="flex:1;" />
          </div>
        </div>
        <div class="field">
          <label>Sort</label>
          <select id="filter-sort" style="width:100%;">
            <option value="">Default</option>
            <option value="price_asc">Price: Low to High</option>
            <option value="price_desc">Price: High to Low</option>
            <option value="year_asc">Year: Oldest</option>
            <option value="year_desc">Year: Newest</option>
          </select>
        </div>
      </section>
    </aside>

    <!-- Showroom & Admin -->
    <section class="content" aria-label="Car showroom">
      <div class="toolbar" role="region" aria-label="Showroom toolbar">
        <div style="display:flex;align-items:center;gap:10px;">
          <span class="label" aria-live="polite">Showing results with emoji-first visuals. Images load lazily and swap to Unsplash on load.</span>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="search-debounced" type="text" placeholder="Search (debounced)" aria-label="Search cars" />
          <button class="btn" id="btn-toggle-admin" aria-expanded="false" aria-controls="admin-panel">Admin</button>
        </div>
      </div>

      <section id="car-grid" class="grid" aria-label="Car catalog grid">
        <!-- Cards injected by JS -->
      </section>

      <!-- Admin panel with two tabs -->
      <section id="admin-panel" class="admin-panel" aria-label="Admin panel" hidden>
        <div class="tabs" role="tablist" aria-label="Admin tabs">
          <button role="tab" aria-selected="true" data-tab="sellers" id="tab-sellers-btn">Sellers</button>
          <button role="tab" aria-selected="false" data-tab="cars" id="tab-cars-btn">Cars</button>
        </div>

        <div class="tab-content" id="tab-sellers" role="region" aria-labelledby="tab-sellers-btn">
          <h3 style="margin:0 0 6px;">Sellers</h3>
          <form id="seller-form" autocomplete="off" style="display:flex; flex-wrap:wrap; gap:8px; align-items:end; margin-bottom:12px;">
            <input name="name" placeholder="Name" required style="min-width:180px;"/>
            <input name="email" placeholder="Email" type="email" required style="min-width:180px;"/>
            <input name="phone" placeholder="Phone" style="min-width:120px;"/>
            <input name="address" placeholder="Address" style="min-width:180px;"/>
            <button class="btn primary" type="submit">Add Seller</button>
          </form>

          <table id="sellers-table" style="width:100%; border-collapse: collapse;">
            <thead>
              <tr><th style="text-align:left; padding:6px 8px;">Name</th><th style="text-align:left; padding:6px 8px;">Email</th><th style="text-align:left; padding:6px 8px;">Phone</th><th style="text-align:left; padding:6px 8px;">Address</th><th style="padding:6px 8px;">Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="tab-content" id="tab-cars" role="region" aria-labelledby="tab-cars-btn" hidden>
          <h3 style="margin:0 0 6px;">Cars</h3>
          <form id="car-form" autocomplete="off" style="display:flex; flex-wrap:wrap; gap:8px; align-items:end; margin-bottom:12px;">
            <select id="car-seller" required style="min-width:180px;">
              <option value="">Select Seller</option>
            </select>
            <input id="car-make" placeholder="Make" required style="min-width:120px;" />
            <input id="car-model" placeholder="Model" required style="min-width:120px;" />
            <input id="car-year" placeholder="Year" type="number" required style="width:90px;" />
            <input id="car-price" placeholder="Price" type="number" required style="width:120px;" />
            <input id="car-mileage" placeholder="Mileage" type="number" required style="width:120px;" />
            <select id="car-body" required style="min-width:130px;">
              <option value="">Body</option>
            </select>
            <select id="car-fuel" required style="min-width:130px;">
              <option value="">Fuel</option>
            </select>
            <select id="car-trans" required style="min-width:130px;">
              <option value="">Transmission</option>
            </select>
            <input id="car-color" placeholder="Color" required style="min-width:100px;" />
            <input id="car-emoji" placeholder="Emoji" value="ðŸš—" style="width:60px;" />
            <input id="car-vin" placeholder="VIN (optional)" />
            <input id="car-qs" placeholder="Unsplash query" required style="min-width:180px;" />
            <button class="btn primary" type="submit">Add Car</button>
          </form>

          <table id="cars-table" style="width:100%; border-collapse: collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:6px 8px;">Car</th><th style="text-align:left; padding:6px 8px;">Seller</th><th style="text-align:left; padding:6px 8px;">Year</th><th style="padding:6px 8px;">Price</th><th style="padding:6px 8px;">Mileage</th><th style="padding:6px 8px;">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
      <div class="toast" id="toast" role="status" aria-live="polite"></div>
    </section>
  </div>

  <!-- Detail modal (car detail) -->
  <div id="detail-modal" class="modal" aria-hidden="true" role="dialog" aria-label="Car details">
    <div class="modal-content">
      <button class="modal-close" aria-label="Close modal">âœ–</button>
      <div id="modal-body" class="modal-body"></div>
    </div>
  </div>

  <script>
    // Minimal, self-contained in-browser "backend" and SPA
    // - JSON-like DB stored in localStorage (af_db)
    // - Two data models: Sellers and Cars
    // - Emoji-first visuals that swap to Unsplash images on load
    // - Admin panel with Sellers and Cars tabs
    // - Debounced search and lazy image loading
    // - Inside-page "API" with CRUD and simple validation

    // Constants
    const DB_KEY = 'af_db';
    const BODY_TYPES = ['Sedan','SUV','Coupe','Hatchback','Truck','Convertible','Van','Wagon'];
    const FUEL_TYPES = ['Gasoline','Diesel','Electric','Hybrid','Other'];
    const TRANSMISSIONS = ['Automatic','Manual','CVT'];

    const nowISO = () => new Date().toISOString();

    // Simple write queue to simulate atomic writes
    let writeQueue = Promise.resolve();
    function enqueueWork(task) {
      return new Promise((resolve, reject) => {
        writeQueue = writeQueue.then(() => {
          try {
            const r = task();
            // Persist after mutation
            persistDB();
            resolve(r);
          } catch (e) {
            reject(e);
          }
        });
      });
    }

    function seedData() {
      const sellers = [
        { id: 's1', name: 'Luna Automotive', email: 'contact@luna.example', phone: '555-0101', address: '1 Moon Ave', createdAt: nowISO(), updatedAt: nowISO() },
        { id: 's2', name: 'Nova Motors', email: 'sales@nova.example', phone: '555-0202', address: '42 Star Blvd', createdAt: nowISO(), updatedAt: nowISO() }
      ];
      const cars = [];
      for (let i = 1; i <= 12; i++) {
        const sId = (i % 2) ? 's1' : 's2';
        const year = 2015 + (i % 7);
        const makes = ['Toyota','Honda','Ford','Chevrolet','Nissan'];
        const models = ['Camry','Civic','F-150','Altima','Rogue','Escape','Accord','Sentra','Ranger','Malibu','Trailblazer','Crew'];
        const make = makes[i % makes.length];
        const model = models[i % models.length];
        const price = 12000 + i * 900;
        const mileage = 35000 + i * 3000;
        const bodyType = BODY_TYPES[i % BODY_TYPES.length];
        const fuel = FUEL_TYPES[i % FUEL_TYPES.length];
        const trans = TRANSMISSIONS[i % TRANSMISSIONS.length];
        const color = ['Red','Blue','White','Black','Silver'][i % 5];
        const vin = 'VIN' + (1000 + i);
        const emoji = 'ðŸš—';
        const unsplashQuery = 'car ' + color;
        cars.push({ id: 'c' + i, sellerId: sId, make, model, year, price, mileage, bodyType, fuel, transmission: trans, color, emoji, unsplashQuery, vin, createdAt: nowISO(), updatedAt: nowISO() });
      }
      const db = { sellers, cars };
      localStorage.setItem(DB_KEY, JSON.stringify(db));
    }

    function loadDB() {
      const raw = localStorage.getItem(DB_KEY);
      if (!raw) {
        seedData();
      }
    }

    function persistDB() {
      const state = {
        sellers: Api._db.sellers,
        cars: Api._db.cars
      };
      localStorage.setItem(DB_KEY, JSON.stringify(state));
    }

    // Lightweight in-browser API
    const Api = (function(){
      // internal cache mirror for UI
      let _db = (() => {
        const raw = localStorage.getItem(DB_KEY);
        if (!raw) {
          // seed
          seedData();
          return { sellers: [], cars: [] };
        }
        try { return JSON.parse(raw); } catch(e){ return { sellers: [], cars: [] }; }
      })();

      // ensure _db reflects persisted data on load
      function refreshFromStorage(){
        const raw = localStorage.getItem(DB_KEY);
        if (raw){
          try { _db = JSON.parse(raw); } catch(e) { /* ignore */ }
        }
      }

      // expose private for admin
      const ensureSeed = () => {
        refreshFromStorage();
        if (!_db || !_db.sellers || _db.sellers.length === 0) {
          seedData();
          refreshFromStorage();
        }
      };

      // simple getters
      function ensureDb(){ ensureSeed(); refreshFromStorage(); }

      // internal create/update/delete helpers
      function _getDb(){ ensureDb(); return _db; }

      function _ensureSellersArray(){ const db = _getDb(); db.sellers = db.sellers || []; db.cars = db.cars || []; }

      function _addSeller(s){
        const db = _getDb();
        db.sellers.push(s);
        persistDB(); refreshFromStorage();
        return s;
      }

      function _addCar(c){
        const db = _getDb();
        db.cars.push(c);
        persistDB(); refreshFromStorage();
        return c;
      }

      function _removeSeller(id){
        const db = _getDb();
        const idx = db.sellers.findIndex(s => s.id === id);
        if (idx >= 0) { db.sellers.splice(idx, 1); persistDB(); refreshFromStorage(); return true; }
        return false;
      }

      function _removeCar(id){
        const db = _getDb();
        const idx = db.cars.findIndex(c => c.id === id);
        if (idx >= 0) { db.cars.splice(idx, 1); persistDB(); refreshFromStorage(); return true; }
        return false;
      }

      // API surface
      const api = {
        _db: _db,
        sellers: {
          getAll: () => {
            ensureDb();
            return _db.sellers.map(s => ({...s})); // shallow copy
          },
          get: (id) => {
            ensureDb();
            return _db.sellers.find(s => s.id === id) || null;
          },
          create: (payload) => enqueueWork(() => {
            const db = _getDb();
            const { name, email, phone, address } = payload;
            if (!name || !email) throw { error: 'Name and email are required' };
            const exists = db.sellers?.some(s => s.email.toLowerCase() === String(email).toLowerCase());
            if (exists) throw { error: 'Seller email must be unique' };
            const id = (typeof crypto?.randomUUID === 'function') ? crypto.randomUUID() : ('s' + Date.now());
            const now = nowISO();
            const seller = { id, name: String(name).trim(), email: String(email).trim(), phone: phone?.toString?.() ?? '', address: address?.toString?.() ?? '', createdAt: now, updatedAt: now };
            db.sellers = db.sellers || [];
            db.sellers.push(seller);
            persistDB();
            return { ...seller };
          }),
          update: (id, payload) => enqueueWork(() => {
            const db = _getDb();
            const seller = db.sellers.find(s => s.id === id);
            if (!seller) throw { error: 'Seller not found' };
            if (payload.email && payload.email !== seller.email){
              const conflict = db.sellers?.some(s => s.email.toLowerCase() === String(payload.email).toLowerCase());
              if (conflict) throw { error: 'Seller email must be unique' };
            }
            Object.assign(seller, payload);
            seller.updatedAt = nowISO();
            persistDB();
            return { ...seller };
          }),
          delete: (id) => enqueueWork(() => {
            const db = _getDb();
            const hasCars = (db.cars||[]).some(c => c.sellerId === id);
            if (hasCars) throw { status: 409, error: 'Cannot delete seller with cars' };
            const idx = db.sellers.findIndex(s => s.id === id);
            if (idx < 0) throw { error: 'Seller not found' };
            db.sellers.splice(idx, 1);
            persistDB();
            return true;
          })
        },
        cars: {
          getAll: () => {
            ensureDb();
            return _db.cars.map(c => ({...c}));
          },
          get: (id) => {
            ensureDb();
            return _db.cars.find(c => c.id === id) || null;
          },
          create: (payload) => enqueueWork(() => {
            const db = _getDb();
            const { sellerId, make, model, year, price, mileage, bodyType, fuel, transmission, color, emoji, unsplashQuery, vin } = payload;
            if (!sellerId || !make || !model || year == null || price == null || mileage == null || !bodyType || !fuel || !transmission || !color || !emoji || !unsplashQuery) {
              throw { error: 'Missing required car fields' };
            }
            const sellerExists = db.sellers?.some(s => s.id === sellerId);
            if (!sellerExists) throw { error: 'Seller not found' };
            if (vin) {
              const usedVin = db.cars?.some(c => c.vin === vin);
              if (usedVin) throw { error: 'VIN must be unique' };
            }
            const id = (typeof crypto?.randomUUID === 'function') ? crypto.randomUUID() : ('c' + Date.now());
            const now = nowISO();
            const car = { id, sellerId, make, model, year: Number(year), price: Number(price), mileage: Number(mileage), bodyType, fuel, transmission, color, emoji, unsplashQuery, vin: vin ?? '', createdAt: now, updatedAt: now };
            db.cars = db.cars || [];
            db.cars.push(car);
            persistDB();
            return { ...car };
          }),
          update: (id, payload) => enqueueWork(() => {
            const db = _getDb();
            const car = db.cars.find(c => c.id === id);
            if (!car) throw { error: 'Car not found' };
            if (payload.sellerId && payload.sellerId !== car.sellerId){
              const exists = db.sellers?.some(s => s.id === payload.sellerId);
              if (!exists) throw { error: 'Seller not found' };
            }
            if (payload.vin !== undefined && payload.vin !== car.vin){
              const existsVin = db.cars?.some(c => c.vin === payload.vin);
              if (existsVin) throw { error: 'VIN must be unique' };
            }
            Object.assign(car, payload);
            car.updatedAt = nowISO();
            persistDB();
            return { ...car };
          }),
          delete: (id) => enqueueWork(() => {
            const db = _getDb();
            const idx = db.cars.findIndex(c => c.id === id);
            if (idx < 0) throw { error: 'Car not found' };
            db.cars.splice(idx, 1);
            persistDB();
            return true;
          }),
          find: (filters) => {
            const db = _getDb();
            let arr = (db.cars || []).map(c => ({...c}));
            const q = (filters?.q || '').toLowerCase().trim();
            if (q) arr = arr.filter(c => `${c.make} ${c.model} ${c.color} ${c.emoji}`.toLowerCase().includes(q));
            if (filters?.make) arr = arr.filter(c => c.make === filters.make);
            if (filters?.model) arr = arr.filter(c => c.model === filters.model);
            if (filters?.bodyType) arr = arr.filter(c => c.bodyType === filters.bodyType);
            if (filters?.fuel) arr = arr.filter(c => c.fuel === filters.fuel);
            if (filters?.transmission) arr = arr.filter(c => c.transmission === filters.transmission);
            if (filters?.color) arr = arr.filter(c => c.color === filters.color);
            if (filters?.minPrice != null) arr = arr.filter(c => Number(c.price) >= Number(filters.minPrice));
            if (filters?.maxPrice != null) arr = arr.filter(c => Number(c.price) <= Number(filters.maxPrice));
            if (filters?.minYear != null) arr = arr.filter(c => Number(c.year) >= Number(filters.minYear));
            if (filters?.maxYear != null) arr = arr.filter(c => Number(c.year) <= Number(filters.maxYear));
            if (filters?.minMileage != null) arr = arr.filter(c => Number(c.mileage) >= Number(filters.minMileage));
            if (filters?.maxMileage != null) arr = arr.filter(c => Number(c.mileage) <= Number(filters.maxMileage));

            if (filters?.sort){
              const s = filters.sort;
              if (s === 'price_asc') arr.sort((a,b)=> a.price - b.price);
              else if (s === 'price_desc') arr.sort((a,b)=> b.price - a.price);
              else if (s === 'year_asc') arr.sort((a,b)=> a.year - b.year);
              else if (s === 'year_desc') arr.sort((a,b)=> b.year - a.year);
            }

            const page = Number(filters?.page) || 1;
            const pageSize = Math.min(Number(filters?.pageSize) || 12, 50);
            const total = arr.length;
            const start = (page-1)*pageSize;
            const end = start + pageSize;
            const items = arr.slice(start, end);
            return { items, total, page, pageSize };
          }
        }
      };

      // Seed wrapper
      function seedIfNeeded(){ /* ensure data present */ }

      // Persisted DB reference
      function _persistIfNeeded(){ persistDB(); }

      // Public API surface
      return {
        _db: _db,
        sellers: api.sellers,
        cars: api.cars
      };
    })();

    // Bind UI
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize DB and UI
      // Ensure DB exists
      const ensure = () => {
        // Ensure data seeded
        const raw = localStorage.getItem(DB_KEY);
        if (!raw){
          // seed
          seedData();
        }
      };
      ensure();

      // Elements
      const carGrid = document.getElementById('car-grid');
      const filterMake = document.getElementById('filter-make');
      const filterModel = document.getElementById('filter-model');
      const filterBody = document.getElementById('filter-body');
      const filterFuel = document.getElementById('filter-fuel');
      const filterTrans = document.getElementById('filter-trans');
      const filterColor = document.getElementById('filter-color');
      const filterMinPrice = document.getElementById('filter-minPrice');
      const filterMaxPrice = document.getElementById('filter-maxPrice');
      const filterMinYear = document.getElementById('filter-minYear');
      const filterMaxYear = document.getElementById('filter-maxYear');
      const filterSort = document.getElementById('filter-sort');
      const filterSearchGlobal = document.getElementById('filter-search-global');
      const searchDebounced = document.getElementById('search-debounced');
      const adminPanel = document.getElementById('admin-panel');
      const btnToggleAdmin = document.getElementById('btn-toggle-admin');
      const sellersTabBtn = document.getElementById('tab-sellers-btn');
      const carsTabBtn = document.getElementById('tab-cars-btn');
      const tabSellers = document.getElementById('tab-sellers');
      const tabCars = document.getElementById('tab-cars');
      const sellersTableBody = document.querySelector('#sellers-table tbody');
      const sellerForm = document.getElementById('seller-form');
      const carsTableBody = document.querySelector('#cars-table tbody');
      const carForm = document.getElementById('car-form');
      const carSellerSelect = document.getElementById('car-seller');
      const carBodySelect = document.getElementById('car-body');
      const carFuelSelect = document.getElementById('car-fuel');
      const carTransSelect = document.getElementById('car-trans');
      const detailModal = document.getElementById('detail-modal');
      const modalBody = document.getElementById('modal-body');
      const modalClose = document.querySelector('.modal-close');
      const toast = document.getElementById('toast');

      // Admin toggle
      btnToggleAdmin.addEventListener('click', () => {
        const open = adminPanel.hidden;
        adminPanel.hidden = !open;
        btnToggleAdmin.setAttribute('aria-expanded', String(!open));
      });

      // Helpers: toast
      function showToast(message, isError=false){
        toast.textContent = message;
        toast.style.background = isError ? '#3a0f2b' : '#111';
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 1800);
      }

      // Populate initial data
      function loadSell ers(){} // placeholder to satisfy linter; not used

      function refreshSellersTable(){
        const db = getDB();
        const sellers = db.sellers || [];
        sellersTableBody.innerHTML = '';
        for (const s of sellers){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="padding:6px 8px;">${s.name}</td>
            <td style="padding:6px 8px;">${s.email}</td>
            <td style="padding:6px 8px;">${s.phone||''}</td>
            <td style="padding:6px 8px;">${s.address||''}</td>
            <td style="padding:6px 8px;">
              <button class="btn" data-action="edit-seller" data-id="${s.id}">Edit</button>
              <button class="btn danger" data-action="delete-seller" data-id="${s.id}">Delete</button>
            </td>
          `;
          sellersTableBody.appendChild(tr);
        }
      }

      // Update seller select options in Cars admin
      function refreshSellerOptions(){
        const db = getDB();
        const sellers = db.sellers || [];
        // Clear
        carSellerSelect.innerHTML = '<option value="">Select Seller</option>';
        for (const s of sellers){
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = s.name;
          carSellerSelect.appendChild(opt);
        }
      }

      function refreshCarsTable(){
        const res = Api.cars.find({ page:1, pageSize: 9999 });
        // Filter by current UI filters? Admin table shows all; add basic
        carsTableBody.innerHTML = '';
        for (const c of res.items){
          const seller = Api.sellers.get ? Api.sellers.get(c.sellerId) : null;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="padding:6px 8px;">
              <span>${c.emoji || 'ðŸš—'}</span>
              <strong>${c.year} ${c.make} ${c.model}</strong> <span class="label" aria-label="vin">${c.vin ? ' VIN '+c.vin : ''}</span>
            </td>
            <td style="padding:6px 8px;">${seller ? seller.name : 'Unknown'}</td>
            <td style="padding:6px 8px;">${c.year}</td>
            <td style="padding:6px 8px;">$${Number(c.price).toLocaleString()}</td>
            <td style="padding:6px 8px;">${Number(c.mileage).toLocaleString()} mi</td>
            <td style="padding:6px 8px;">
              <button class="btn" data-action="edit-car" data-id="${c.id}">Edit</button>
              <button class="btn danger" data-action="delete-car" data-id="${c.id}">Delete</button>
            </td>
          `;
          carsTableBody.appendChild(tr);
        }
      }

      // Helper: get DB (cached)
      function getDB(){ try { return JSON.parse(localStorage.getItem(DB_KEY)); } catch(e){ return { sellers: [], cars: [] }; } }

      // Initialize: build select options for body, fuels, etc., and seller list
      function initAdminSelections(){
        // Body
        carBodySelect.innerHTML = '<option value="">Body</option>';
        BODY_TYPES.forEach(b => {
          const opt = document.createElement('option');
          opt.value = b;
          opt.textContent = b;
          carBodySelect.appendChild(opt);
        });
        // Fuel
        carFuelSelect.innerHTML = '<option value="">Fuel</option>';
        FUEL_TYPES.forEach(f => {
          const opt = document.createElement('option');
          opt.value = f;
          opt.textContent = f;
          carFuelSelect.appendChild(opt);
        });
        // Transmission
        carTransSelect.innerHTML = '<option value="">Transmission</option>';
        TRANSMISSIONS.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t;
          opt.textContent = t;
          carTransSelect.appendChild(opt);
        });
      }

      // Initialize admin data
      function initAdminData(){
        refreshSellersTable();
        refreshSellerOptions();
        initAdminSelections();
        refreshCarsTable();
      }

      // Seller CRUD handlers
      sellerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const form = new FormData(sellerForm);
        const payload = {
          name: form.get('name'),
          email: form.get('email'),
          phone: form.get('phone'),
          address: form.get('address')
        };
        Api.sellers.create(payload).then(seller => {
          showToast('Seller added');
          sellerForm.reset();
          refreshSellersTable();
          refreshSellerOptions();
        }).catch(err => {
          showToast(err?.error || 'Error creating seller', true);
        });
      });

      sellersTableBody.addEventListener('click', (ev) => {
        const btn = ev.target.closest('[data-action]');
        if (!btn) return;
        const action = btn.getAttribute('data-action');
        const id = btn.getAttribute('data-id');
        if (action === 'delete-seller'){
          Api.sellers.delete(id).then(() => {
            showToast('Seller deleted');
            refreshSellersTable();
            refreshSellerOptions();
          }).catch(err => {
            showToast(err?.error || 'Cannot delete seller', err?.status === 409);
          });
        } else if (action === 'edit-seller'){
          // Inline simple edit prompt
          const seller = Api.sellers.getAll().find(s => s.id === id) || null;
          if (!seller) return;
          const newName = prompt('Edit name:', seller.name);
          if (newName == null) return;
          Api.sellers.update(id, { name: newName }).then(() => {
            showToast('Seller updated');
            refreshSellersTable();
            refreshSellerOptions();
          }).catch(err => showToast(err?.error || 'Update failed', true));
        }
      });

      // Car CRUD handlers
      carForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const payload = {
          sellerId: carSellerSelect.value,
          make: document.getElementById('car-make').value,
          model: document.getElementById('car-model').value,
          year: document.getElementById('car-year').value,
          price: document.getElementById('car-price').value,
          mileage: document.getElementById('car-mileage').value,
          bodyType: carBodySelect.value,
          fuel: carFuelSelect.value,
          transmission: carTransSelect.value,
          color: document.getElementById('car-color').value,
          emoji: document.getElementById('car-emoji').value || 'ðŸš—',
          unsplashQuery: document.getElementById('car-qs').value,
          vin: document.getElementById('car-vin').value
        };
        Api.cars.create(payload).then(car => {
          showToast('Car added');
          carForm.reset();
          refreshCarsTable();
        }).catch(err => showToast(err?.error || 'Error adding car', true));
      });

      carsTableBody.addEventListener('click', (ev) => {
        const btn = ev.target.closest('[data-action]');
        if(!btn) return;
        const action = btn.getAttribute('data-action');
        const id = btn.getAttribute('data-id');
        if (action === 'delete-car'){
          Api.cars.delete(id).then(() => {
            showToast('Car deleted');
            refreshCarsTable();
          }).catch(err => showToast(err?.error || 'Delete failed', true));
        } else if (action === 'edit-car'){
          const car = Api.cars.getAll().find(c => c.id === id);
          if (!car) return;
          const newPrice = prompt('New price', car.price);
          if (newPrice == null) return;
          Api.cars.update(id, { price: Number(newPrice) }).then(() => {
            showToast('Car updated');
            refreshCarsTable();
          }).catch(err => showToast(err?.error || 'Update failed', true));
        }
      });

      // Detail modal on card (not used in admin; here for user showroom)
      modalClose.addEventListener('click', () => { detailModal.setAttribute('aria-hidden', 'true'); });
      detailModal.addEventListener('click', (e) => {
        if (e.target === detailModal) detailModal.setAttribute('aria-hidden', 'true');
      });

      // Initial load
      initAdminData();
    });

    // Car showroom rendering (emoji-first visuals; images lazy-load via IntersectionObserver)
    function renderCarCard(car){
      const seller = Api.sellers.getAll().find(s => s.id === car.sellerId);
      const card = document.createElement('article');
      card.className = 'card';
      card.setAttribute('aria-label', `${car.year} ${car.make} ${car.model}`);
      // Media with emoji and image placeholder
      const imgQuery = car.unsplashQuery || 'car';
      // For lazy loading, data-src points to unsplash source
      const media = document.createElement('div');
      media.className = 'card-media';
      const skeleton = document.createElement('div');
      skeleton.className = 'skeleton';
      skeleton.style.display = 'block';
      media.appendChild(skeleton);

      const img = document.createElement('img');
      img.className = 'car-img';
      img.alt = `${car.year} ${car.make} ${car.model}`;
      img.setAttribute('data-src', `https://source.unsplash.com/600x400/?${encodeURIComponent(imgQuery)}&car`);
      img.style.display = 'block';
      media.appendChild(img);

      const emoji = document.createElement('span');
      emoji.className = 'emoji';
      emoji.textContent = car.emoji || 'ðŸš—';
      media.appendChild(emoji);

      // Card body
      const body = document.createElement('div');
      body.className = 'card-body';
      const title = document.createElement('h3');
      title.className = 'car-title';
      title.textContent = `${car.year} ${car.make} ${car.model}`;
      const sellerP = document.createElement('p');
      sellerP.style.margin = '0';
      sellerP.textContent = `Seller: ${seller ? seller.name : 'Unknown'}`;
      const priceP = document.createElement('p');
      priceP.style.margin = '0';
      priceP.textContent = `Price: $${Number(car.price).toLocaleString()}`;
      const mileP = document.createElement('p');
      mileP.style.margin = '0';
      mileP.textContent = `Mileage: ${Number(car.mileage).toLocaleString()} mi`;

      // Actions
      const actions = document.createElement('div');
      actions.className = 'row';
      const viewBtn = document.createElement('button');
      viewBtn.className = 'btn';
      viewBtn.textContent = 'View';
      viewBtn.addEventListener('click', () => openDetail(car));
      const quickBuy = document.createElement('button');
      quickBuy.className = 'btn';
      quickBuy.textContent = 'Inquire';
      actions.appendChild(viewBtn);
      actions.appendChild(quickBuy);

      body.appendChild(title);
      body.appendChild(sellerP);
      body.appendChild(priceP);
      body.appendChild(mileP);
      body.appendChild(actions);

      card.appendChild(media);
      card.appendChild(body);

      // IntersectionObserver for lazy load
      if ('IntersectionObserver' in window){
        const observer = new IntersectionObserver((entries, obs) => {
          entries.forEach(entry => {
            if (entry.isIntersecting){
              const i = entry.target.querySelector('img.car-img');
              if (i && !i.src){
                const src = i.getAttribute('data-src');
                if (src){
                  i.src = src;
                }
              }
              obs.unobserve(entry.target);
            }
          });
        }, { rootMargin: '100px' });
        observer.observe(card);
      } else {
        // fallback: load immediately
        const i = img;
        if (i && !i.src){
          const src = i.getAttribute('data-src');
          if (src) i.src = src;
        }
      }

      // When image loads, swap emoji out
      img.addEventListener('load', () => {
        skeleton.style.display = 'none';
        emoji.style.display = 'none';
        img.style.opacity = '1';
      });
      img.addEventListener('error', () => {
        // keep emoji on error
        skeleton.style.display = 'none';
      });

      return card;
    }

    function openDetail(car){
      const seller = Api.sellers.getAll().find(s => s.id === car.sellerId);
      modalBody.innerHTML = `
        <h3>${car.year} ${car.make} ${car.model} ${car.vin ? `- VIN ${car.vin}` : ''}</h3>
        <p>Seller: ${seller?.name ?? 'Unknown'}</p>
        <p>Price: $${Number(car.price).toLocaleString()}</p>
        <p>Mileage: ${Number(car.mileage).toLocaleString()} miles</p>
        <p>Body: ${car.bodyType} â€¢ Fuel: ${car.fuel} â€¢ Transmission: ${car.transmission}</p>
        <p>Color: ${car.color}</p>
        <img src="https://source.unsplash.com/1200x800/?${encodeURIComponent(car.unsplashQuery)}" alt="Car image"/>
      `;
      detailModal.setAttribute('aria-hidden','false');
      // focus trap (basic)
      setTimeout(() => {
        detailModal.querySelector('.modal-close')?.focus();
      }, 50);
    }

    function renderCars(){
      const res = Api.cars.find({ page: 1, pageSize: 9999 });
      carGrid.innerHTML = '';
      // Sort by id stable; just render
      res.items.forEach(car => {
        const card = renderCarCard(car);
        carGrid.appendChild(card);
      });
      // Also populate admin car page data
      initAdminCarList();
    }

    // Debounced global search (UI)
    function debounce(fn, delay=250){
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), delay);
      };
    }

    // Admin: populate car form selects using current db
    function initAdminCarForm(){
      // ensure seller options exist
      const sellers = Api.sellers.getAll();
      carSellerSelect.innerHTML = '<option value="">Select Seller</option>';
      sellers.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        carSellerSelect.appendChild(opt);
      });
    }

    // Admin: refresh both car and seller tables
    function initAdminCarList(){
      // Car table already refreshed on add; nothing else needed here
    }

    // Public quick helpers
    function getAllMakes(){
      const cars = Api.cars.getAll();
      const set = new Set();
      cars.forEach(c => set.add(c.make));
      return Array.from(set);
    }

    // Init: render showroom area and admin tables
    function initialRender(){
      // build make/model options for filters (global)
      const makes = getAllMakes();
      filterMake.innerHTML = '<option value="">Any</option>' + makes.map(m => `<option value="${m}">${m}</option>`).join('');
      // Build models list similarly (optional)
      const models = Array.from(new Set(Api.cars.getAll().map(c => c.model))).slice(0, 20);
      filterModel.innerHTML = '<option value="">Any</option>' + models.map(m => `<option value="${m}">${m}</option>`).join('');
      // Body types
      const body = BODY_TYPES;
      filterBody.innerHTML = '<option value="">Any</option>' + body.map(b => `<option value="${b}">${b}</option>`).join('');
      // Fuels
      filterFuel.innerHTML = '<option value="">Any</option>' + FUEL_TYPES.map(f => `<option value="${f}">${f}</option>`).join('');
      // Trans
      filterTrans.innerHTML = '<option value="">Any</option>' + TRANSMISSIONS.map(t => `<option value="${t}">${t}</option>`).join('');
      // Year bounds
      const years = Api.cars.getAll().map(c => c.year);
      const minY = Math.min(...years), maxY = Math.max(...years);
      filterMinYear.value = minY;
      filterMaxYear.value = maxY;
      // Make car filter selects reflect available options
      refreshAllFilters();
      // Render grid
      renderCars();

      // Prepare admin selects
      refreshSellersListForAdmin();
      initAdminCarForm();
    }

    function refreshAllFilters(){
      // Debounced search handler to filter grid
      const applyFilters = () => {
        const f = {
          make: filterMake.value || null,
          model: filterModel.value || null,
          bodyType: filterBody.value || null,
          fuel: filterFuel.value || null,
          transmission: filterTrans.value || null,
          color: filterColor.value || null,
          minPrice: filterMinPrice.value || null,
          maxPrice: filterMaxPrice.value || null,
          minYear: filterMinYear.value || null,
          maxYear: filterMaxYear.value || null,
          q: (filterSearchGlobal.value || '').trim(),
          sort: filterSort.value || null,
          page: 1,
          pageSize: 12
        };
        const res = Api.cars.find(f);
        carGrid.innerHTML = '';
        res.items.forEach(car => {
          carGrid.appendChild(renderCarCard(car));
        });
      };
      // Attach listeners
      [filterMake, filterModel, filterBody, filterFuel, filterTrans, filterColor,
        filterMinPrice, filterMaxPrice, filterMinYear, filterMaxYear, filterSort, filterSearchGlobal]
      .forEach(el => {
        if (!el) return;
        el.addEventListener('change', debounce(applyFilters, 250));
        el.addEventListener('input', debounce(applyFilters, 250));
      });
      // Initial run
      applyFilters();
    }

    function refreshSellersListForAdmin(){
      // Update the seller dropdown in Cars admin
      const sellers = Api.sellers.getAll();
      carSellerSelect.innerHTML = '<option value="">Select Seller</option>';
      sellers.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        carSellerSelect.appendChild(opt);
      });
    }

    // Initialize admin tab switching
    // In this simplified version, we toggle visibility
    document.addEventListener('click', (e) => {
      const t = e.target;
      if (t && t.dataset && t.dataset.tab) {
        const tab = t.dataset.tab;
        if (tab === 'sellers') {
          tabSellers.hidden = false;
          tabCars.hidden = true;
          t.setAttribute('aria-selected','true');
          carsTabBtn.setAttribute('aria-selected','false');
        } else if (tab === 'cars') {
          tabSellers.hidden = true;
          tabCars.hidden = false;
          t.setAttribute('aria-selected','true');
          sellersTabBtn.setAttribute('aria-selected','false');
        }
      }
    });

    // View: build initial transmission
    // Window: Initialize
    window.addEventListener('load', () => {
      // Wire modal close
      modalClose.addEventListener('click', () => {
        detailModal.setAttribute('aria-hidden','true');
      });
      // Show first tab by default
      tabSellers.hidden = true;
      tabCars.hidden = false;
    });

    // Lazy: handle admin panel open
    // After DOM ready, render showroom and admin
    // The Admin UI uses Api directly; ensure data seeds exist now
    // Seed if needed and render
    (function bootstrap(){
      // Ensure DB exists
      const raw = localStorage.getItem(DB_KEY);
      if (!raw) seedData();
      // Render initial UI
      initialRender();
    })();
  </script>

  
</body>
</html>