<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShopNest — Catalog, Product Details & Cart SPA</title>
  <style>
    /* Color tokens (must be used consistently) */
    :root {
      --bg: #f7f9fc;
      --surface: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #e5e7eb;

      --brand-50: #eef2ff;
      --brand-100: #e0e7ff;
      --brand-500: #4f46e5; /* primary */
      --brand-600: #4353e0;
      --brand-700: #3730a3;

      --green-500: #16a34a;
      --red-500: #ef4444;
      --amber-500: #f59e0b;
      --cyan-500: #14b8a6;

      --shadow: 0 6px 20px rgba(0,0,0,.08);
      --radius: 14px;
    }

    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; font-family: Inter, ui-sans-serif, system-ui, -apple-system; color: var(--text); background: var(--bg); }
    a { color: inherit; text-decoration: none; }

    /* Layout */
    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      width: min(1100px, 92vw);
      margin: 0 auto;
    }

    /* Header */
    header.app-header {
      position: sticky; top: 0; z-index: 40;
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 20px;
      background: #fff;
      border-bottom: 1px solid var(--border);
      box-shadow: 0 1px 0 rgba(0,0,0,.04);
    }
    .brand {
      display: flex; align-items: center; gap: 12px;
      font-weight: 800; letter-spacing: .2px;
    }
    .brand .logo {
      width: 34px; height: 34px; border-radius: 9px;
      background: linear-gradient(135deg, var(--brand-700), var(--brand-500));
      display: grid; place-items: center; color: white; font-weight: 900;
    }
    .brand .name { font-size: 1.05rem; }

    .search {
      flex: 1; display: flex; justify-content: center;
    }
    .search input {
      width: 100%; max-width: 520px;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: #fff;
      outline: none;
      font-size: 14px;
    }
    .actions { display: flex; align-items: center; gap: 10px; }

    .btn {
      border: 1px solid var(--border);
      background: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      transition: all .2s ease;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn.primary {
      background: var(--brand-500);
      color: #fff; border: none;
    }
    .btn.ghost { background: transparent; border-color: var(--border); }

    /* Filters bar */
    .filters {
      display: grid; grid-template-columns: 1fr 1fr 1fr auto;
      gap: 12px; padding: 12px 0; align-items: center;
    }
    .filters label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    select, input[type="number"], input[type="range"] {
      width: 100%; padding: 10px 12px; border-radius: 8px;
      border: 1px solid var(--border); background: #fff;
      font-size: 14px;
    }
    .range-row { display:flex; gap:8px; align-items: center; }
    .range-row input[type="range"] { width: 100%; }

    /* Catalog grid */
    main#catalog {
      padding: 16px 0 40px;
      display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 14px;
    }
    .card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: 12px; display: flex; flex-direction: column; gap: 8px;
      transition: transform .2s ease;
    }
    .card:hover { transform: translateY(-2px); }
    .card img { width: 100%; height: 140px; object-fit: cover; border-radius: 8px; background: #f3f4f6; }
    .card-title { font-weight: 700; font-size: 16px; }
    .card-desc { font-size: 13px; color: var(--muted); min-height: 34px; }
    .price { font-weight: 800; font-size: 15px; }
    .stock { font-size: 12px; color: var(--muted); }

    .rating { display: inline-flex; gap: 2px; align-items: center; font-size: 12px; color: #f59e0b; }
    .star { width: 14px; height: 14px; display: inline-block; }

    @media (max-width: 800px) {
      .filters { grid-template-columns: 1fr 1fr; gap: 8px; }
    }
    @media (max-width: 520px) {
      header.app-header { padding: 12px; }
      .filters { grid-template-columns: 1fr; }
      main#catalog { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
    }

    /* Product detail modal */
    .modal {
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,.45);
      z-index: 50;
    }
    .modal[aria-hidden="false"] { display: flex; }
    .modal-content {
      width: min(680px, 92vw);
      background: #fff; border-radius: 12px; padding: 20px; max-height: 86vh; overflow: auto;
      box-shadow: var(--shadow);
    }
    .modal-header { display:flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .modal-body { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .modal-body img { width: 100%; height: auto; border-radius: 8px; }
    .muted { color: var(--muted); }

    /* Cart drawer (right side) */
    .drawer {
      position: fixed; top: 0; right: 0; height: 100%; width: 360px;
      background: #fff; border-left: 1px solid var(--border);
      transform: translateX(100%); transition: transform .25s ease;
      z-index: 60; display: flex; flex-direction: column;
    }
    .drawer.open { transform: translateX(0); }
    .drawer-header { padding: 14px; display:flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
    .drawer-content { padding: 12px; flex: 1; overflow: auto; display: flex; flex-direction: column; gap: 12px; }
    .drawer-footer { padding: 12px; border-top: 1px solid var(--border); }

    .cart-item { display: grid; grid-template-columns: 60px 1fr auto; gap: 8px; align-items: center; padding: 8px; border: 1px solid var(--border); border-radius: 8px; }
    .cart-thumb { width: 60px; height: 40px; object-fit: cover; border-radius: 6px; background: #f0f0f0; }
    .cart-name { font-weight: 600; font-size: 13px; }
    .qty-controls { display:flex; align-items:center; gap:6px; }
    .qty-controls button { width:26px; height:26px; border-radius:6px; border:1px solid var(--border); background:#fff; }

    /* Checkout modal */
    .checkout-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.4); z-index: 70; }
    .checkout-modal[aria-hidden="false"] { display: flex; }
    .checkout-content { width: min(720px, 92vw); background: #fff; border-radius: 12px; padding: 16px; box-shadow: var(--shadow); }
    .checkout-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .checkout-grid label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .checkout-grid input, .checkout-grid textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; }

    .order-success { text-align: center; padding: 20px; }
    .hidden { display: none !important; }

    /* Tiny helper sections (Getting started) */
    details { margin: 14px 0; }
    summary { cursor: default; font-weight: 600; }
  </style>
</head>
<body>
  <div class="app">
    <!-- Getting started (in-page instructions) -->
    <header class="app-header" aria-label="Site header">
      <div class="brand" aria-label="Brand">
        <div class="logo" aria-label="Logo">S</div>
        <div class="name">ShopNest</div>
      </div>

      <div class="search" aria-label="Site search">
        <input id="searchInput" type="search" placeholder="Search products..." aria-label="Search products" />
      </div>

      <div class="actions">
        <button class="btn ghost" id="openCartBtn" aria-label="Open cart">Cart</button>
        <button class="btn primary" id="checkoutBtnHeader" aria-label="Start checkout" title="Proceed to checkout">Checkout</button>
      </div>
    </header>

    <section class="container" aria-label="Getting started and controls" style="padding:10px 0 0;">
      <details open>
        <summary>Getting started</summary>
        <p style="margin:6px 0 0; color:var(--muted); font-size:13px;">
          No build tools required. Open this file directly in a modern browser.
          Data is stored locally in your browser. Use the controls below to filter, search, view details, add to cart, and simulate checkout.
        </p>
      </details>
    </section>

    <!-- Filters -->
    <section class="container filters" aria-label="Product filters">
      <div>
        <label for="categoryFilter">Category</label>
        <select id="categoryFilter" aria-label="Filter by category">
          <option value="All">All</option>
        </select>
      </div>

      <div class="range-row" aria-label="Price range">
        <div style="flex:1;">
          <label for="minPrice">Min price</label>
          <input id="minPrice" type="number" min="0" step="1" value="0" />
        </div>
        <div style="flex:1;">
          <label for="maxPrice">Max price</label>
          <input id="maxPrice" type="number" min="0" step="1" value="1000" />
        </div>
      </div>

      <div>
        <label for="minRating">Min rating</label>
        <select id="minRating" aria-label="Minimum rating">
          <option value="0">All ratings</option>
          <option value="3">3★+</option>
          <option value="4">4★+</option>
          <option value="4.5">4.5★+</option>
        </select>
      </div>

      <div>
        <label for="sortSelect">Sort by</label>
        <select id="sortSelect" aria-label="Sort products">
          <option value="relevance">Relevance</option>
          <option value="price-asc">Price: Low to High</option>
          <option value="price-desc">Price: High to Low</option>
          <option value="rating-desc">Rating</option>
        </select>
      </div>

      <div>
        <label>&nbsp;</label>
        <button class="btn" id="clearFilters" aria-label="Clear filters" title="Clear filters">Clear</button>
      </div>
    </section>

    <!-- Catalog -->
    <main id="catalog" class="container" aria-label="Product catalog">
      <!-- Product cards are rendered by JS here -->
    </main>

    <!-- Product detail modal -->
    <div id="productDetail" class="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Product details">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="detailTitle" style="margin:0; font-size:1.1rem;">Product</h3>
          <button class="btn" id="closeDetail" aria-label="Close product details">Close</button>
        </div>
        <div class="modal-body">
          <img id="detailImage" src="" alt="Product image" />
          <div>
            <p id="detailDesc" class="muted" style="margin:6px 0 12px; line-height:1.4;"></p>
            <p><strong>Price:</strong> <span id="detailPrice"></span></p>
            <p><strong>Category:</strong> <span id="detailCategory"></span></p>
            <p><strong>Stock:</strong> <span id="detailStock"></span></p>
            <div class="rating" aria-label="Product rating">
              <span id="detailRating"></span>
            </div>
            <button class="btn primary" id="detailAddToCart" style="margin-top:8px;">Add to cart</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Cart Drawer -->
    <aside id="cartDrawer" class="drawer" aria-label="Shopping cart" aria-hidden="true" role="complementary">
      <div class="drawer-header">
        <strong>Your cart</strong>
        <button class="btn" id="closeCart" aria-label="Close cart">Close</button>
      </div>
      <div class="drawer-content" id="cartContent" aria-live="polite">
        <!-- Cart items injected by JS -->
      </div>
      <div class="drawer-footer">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:8px;">
          <span>Subtotal</span>
          <strong id="cartSubtotal" aria-label="Cart subtotal">$0.00</strong>
        </div>
        <button class="btn primary" id="checkoutFromCart" aria-label="Checkout from cart">Checkout</button>
      </div>
    </aside>

    <!-- Checkout modal -->
    <div id="checkoutModal" class="checkout-modal" aria-hidden="true" role="dialog" aria-label="Checkout">
      <div class="checkout-content">
        <div style="display:flex; justify-content: space-between; align-items:center;">
          <h3 style="margin:0;">Checkout</h3>
          <button class="btn" id="closeCheckout" aria-label="Close checkout">Close</button>
        </div>
        <form id="checkoutForm" class="checkout-grid" style="margin-top:8px;">
          <div>
            <label for="name">Full name</label>
            <input id="name" name="name" required placeholder="Jane Doe" />
          </div>
          <div>
            <label for="email">Email</label>
            <input id="email" name="email" type="email" required placeholder="jane@example.com" />
          </div>
          <div>
            <label for="address">Address</label>
            <input id="address" name="address" required placeholder="123 Main St" />
          </div>
          <div>
            <label for="city">City</label>
            <input id="city" name="city" required placeholder="City" />
          </div>
          <div>
            <label for="postal">Postal Code</label>
            <input id="postal" name="postal" required placeholder="12345" />
          </div>
          <div style="grid-column:1 / -1;">
            <label for="notes">Notes</label>
            <textarea id="notes" name="notes" placeholder="Delivery instructions..."></textarea>
          </div>
          <div style="display:flex; gap:8px; grid-column:1 / -1; justify-content:flex-end;">
            <button type="button" class="btn" id="cancelCheckoutAlt">Cancel</button>
            <button type="submit" class="btn primary">Place order</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Order status / confirmation -->
    <div id="orderStatus" class="modal" aria-hidden="true" role="dialog" aria-label="Order status">
      <div class="modal-content">
        <div class="modal-header">
          <h3 style="margin:0;">Order Confirmation</h3>
          <button class="btn" id="closeOrderStatus" aria-label="Close confirmation">Close</button>
        </div>
        <div class="order-success" id="orderSuccessContent">
          <!-- Filled by JS -->
        </div>
      </div>
    </div>

    <footer style="padding:20px; text-align:center; color:var(--muted); font-size:12px;">
      SPA prototype: catalog, product details, and cart with a simulated checkout flow. All data stored locally in your browser.
    </footer>
  </div>

  <script>
    // Data model (mock products)
    const cityColors = {
      Electronics: '#4f46e5',
      Books: '#0ea5e9',
      Home: '#f59e0b',
      Apparel: '#10b981'
    };

    function imgFor(label, category) {
      const color = cityColors[category] || '#64748b';
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="400" height="260" viewBox="0 0 400 260">
          <defs>
            <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
              <stop stop-color="${color}" offset="0"/>
              <stop stop-color="#ffffff" offset="1"/>
            </linearGradient>
          </defs>
          <rect width="100%" height="100%" fill="url(#g)"/>
          <text x="50%" y="54%" font-family="Arial" font-size="28" text-anchor="middle" fill="#fff" font-weight="700">${label}</text>
        </svg>
      `;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }

    const products = [
      { id: 'p1', name: 'Aurora Wireless Headphones', description: 'Noise-cancelling over-ear headphones with 40h battery life and crystal-clear call quality.',
        price: 89.99, category: 'Electronics', rating: 4.5, stock: 12, image: imgFor('Headphones', 'Electronics') },
      { id: 'p2', name: 'Nimbus E-Reader', description: '7-inch glare-free e-reader with warm light and weeks of battery life.',
        price: 129.99, category: 'Electronics', rating: 4.2, stock: 5, image: imgFor('E-Reader', 'Electronics') },
      { id: 'p3', name: 'BiblioSoft: JavaScript Guide', description: 'Comprehensive reference with examples and actionable patterns.',
        price: 29.99, category: 'Books', rating: 4.8, stock: 20, image: imgFor('Book', 'Books') },
      { id: 'p4', name: 'ChefMate Mixing Bowl Set', description: 'Durable bowls with non-slip bases and a range of sizes.',
        price: 24.5, category: 'Home', rating: 4.1, stock: 0, image: imgFor('MIX', 'Home') },
      { id: 'p5', name: 'LumaSmart Lamp', description: 'LED desk lamp with color temperature control and touch dimmer.',
        price: 39.99, category: 'Home', rating: 4.4, stock: 8, image: imgFor('Lamp', 'Home') },
      { id: 'p6', name: 'Trailblazer Hoodie', description: 'Breathable fleece hoodie for outdoor adventures.',
        price: 54.99, category: 'Apparel', rating: 4.6, stock: 15, image: imgFor('Hoodie', 'Apparel') },
      { id: 'p7', name: 'AeroRunning Shoes', description: 'Lightweight sneakers with responsive foam and durable grip.',
        price: 74.99, category: 'Apparel', rating: 4.3, stock: 3, image: imgFor('Shoes', 'Apparel') },
      { id: 'p8', name: 'Pocket Sketch Kit', description: 'Compact notebook and pencil set for on-the-go artists.',
        price: 12.99, category: 'Books', rating: 4.0, stock: 25, image: imgFor('Sketch', 'Books') }
    ];

    // State
    let cart = [];
    const CART_KEY = 'shopnest_cart';
    const VIEW_KEY = 'shopnest_last_view';
    const currency = 'USD';
    const locale = 'en-US';

    // DOM refs
    const catalogEl = document.getElementById('catalog');
    const categoryFilter = document.getElementById('categoryFilter');
    const minPriceInput = document.getElementById('minPrice');
    const maxPriceInput = document.getElementById('maxPrice');
    const minRatingFilter = document.getElementById('minRating');
    const sortSelect = document.getElementById('sortSelect');
    const searchInput = document.getElementById('searchInput');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const detailModal = document.getElementById('productDetail');
    const detailTitle = document.getElementById('detailTitle');
    const detailImage = document.getElementById('detailImage');
    const detailDesc = document.getElementById('detailDesc');
    const detailPrice = document.getElementById('detailPrice');
    const detailCategory = document.getElementById('detailCategory');
    const detailStock = document.getElementById('detailStock');
    const detailRating = document.getElementById('detailRating');
    const detailAddToCartBtn = document.getElementById('detailAddToCart');
    const closeDetailBtn = document.getElementById('closeDetail');

    const cartDrawer = document.getElementById('cartDrawer');
    const openCartBtn = document.getElementById('openCartBtn');
    const closeCartBtn = document.getElementById('closeCart');
    const cartContent = document.getElementById('cartContent');
    const cartSubtotalEl = document.getElementById('cartSubtotal');
    const checkoutFromCartBtn = document.getElementById('checkoutFromCart');
    const checkoutBtnHeader = document.getElementById('checkoutBtnHeader');
    const checkoutModal = document.getElementById('checkoutModal');
    const closeCheckoutBtn = document.getElementById('closeCheckout');
    const closeCheckoutAltBtn = document.getElementById('cancelCheckoutAlt');
    const checkoutForm = document.getElementById('checkoutForm');
    const orderStatus = document.getElementById('orderStatus');
    const orderSuccessContent = document.getElementById('orderSuccessContent');
    const closeOrderStatusBtn = document.getElementById('closeOrderStatus');
    const closeOrderStatusFromModal = document.getElementById('closeOrderStatus');

    // Helpers
    function formatCurrency(n) {
      return new Intl.NumberFormat(locale, { style: 'currency', currency }).format(n);
    }

    function saveCart() {
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
      updateCartCount();
    }

    function loadCart() {
      const raw = localStorage.getItem(CART_KEY);
      if (raw) {
        try { cart = JSON.parse(raw); } catch { cart = []; }
      }
      updateCartCount();
    }

    function updateCartCount() {
      const totalQty = cart.reduce((a, c) => a + c.qty, 0);
      openCartBtn.setAttribute('aria-label', `Open cart with ${totalQty} items`);
    }

    function getProduct(id) {
      return products.find(p => p.id === id);
    }

    function addToCart(productId, qty = 1) {
      const pid = productId;
      const p = getProduct(pid);
      if (!p) return;
      const existing = cart.find(item => item.productId === pid);
      const nextQty = existing ? existing.qty + qty : qty;
      if (p.stock < nextQty) {
        alert('Not enough stock available.');
        return;
      }
      if (existing) {
        existing.qty = nextQty;
      } else {
        cart.push({ productId: pid, qty: qty });
      }
      saveCart();
      renderCart();
    }

    function removeFromCart(productId) {
      cart = cart.filter(item => item.productId !== productId);
      saveCart();
      renderCart();
    }

    function setCartQty(productId, qty) {
      const item = cart.find(i => i.productId === productId);
      if (!item) return;
      const p = getProduct(productId);
      if (!p) return;
      if (qty <= 0) {
        removeFromCart(productId);
      } else if (qty <= p.stock) {
        item.qty = qty;
        saveCart();
        renderCart();
      }
    }

    function cartSubtotal() {
      return cart.reduce((sum, item) => {
        const p = getProduct(item.productId);
        return sum + (p ? p.price * item.qty : 0);
      }, 0);
    }

    function persistLastView(id) {
      localStorage.setItem(VIEW_KEY, id);
    }

    function renderProductCard(p) {
      const card = document.createElement('article');
      card.className = 'card';
      card.setAttribute('role', 'article');
      card.style.display = 'flex';
      card.style.flexDirection = 'column';
      // Card content
      card.innerHTML = `
        <img src="${p.image}" alt="${p.name}">
        <div class="card-title" style="display:flex; justify-content:space-between; align-items:center;">
          <span>${p.name}</span>
          <span class="price" aria-label="Price">${formatCurrency(p.price)}</span>
        </div>
        <div class="card-desc" title="${p.description}">${p.description}</div>
        <div style="display:flex; justify-content: space-between; align-items: center;">
          <span class="rating" aria-label="Rating ${p.rating}">${'★'.repeat(Math.floor(p.rating))}${p.rating % 1 >= 0.5 ? '☆' : ''}</span>
          <span class="stock" aria-label="Stock ${p.stock}">${p.stock > 0 ? 'In stock' : 'Out of stock'}</span>
        </div>
        <div style="margin-top:auto; display:flex; gap:8px;">
          <button class="btn" data-id="${p.id}" aria-label="View details">Details</button>
          <button class="btn primary" data-id="${p.id}" ${p.stock<=0?'disabled':''} aria-label="Add to cart">Add to cart</button>
        </div>
      `;
      // Events
      const detailBtn = card.querySelector('button[data-id][aria-label="View details"]');
      const addBtn = card.querySelector('button[data-id][aria-label="Add to cart"]');
      detailBtn.addEventListener('click', () => openDetail(p.id));
      addBtn.addEventListener('click', () => addToCart(p.id, 1));
      // click image or name to open detail
      const imgEl = card.querySelector('img');
      imgEl.style.cursor = 'pointer';
      imgEl.addEventListener('click', () => openDetail(p.id));
      return card;
    }

    function renderCatalog(list = null) {
      const data = list || products;
      catalogEl.innerHTML = '';
      if (data.length === 0) {
        catalogEl.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--muted);">No products match your filters.</div>';
        return;
      }
      for (const p of data) {
        catalogEl.appendChild(renderProductCard(p));
      }
    }

    function applyFilters() {
      const q = (searchInput.value || '').toLowerCase().trim();
      const cat = categoryFilter.value;
      const minP = Number(minPriceInput.value) || 0;
      const maxP = Number(maxPriceInput.value) || Number.POSITIVE_INFINITY;
      const minR = Number(minRatingFilter.value) || 0;
      const sortKey = sortSelect.value;

      let list = products.filter(p => {
        if (cat !== 'All' && p.category !== cat) return false;
        if (q && !(p.name.toLowerCase().includes(q) || p.description.toLowerCase().includes(q))) return false;
        if (p.price < minP || p.price > maxP) return false;
        if (p.rating < minR) return false;
        return true;
      });

      if (sortKey === 'price-asc') list = list.slice().sort((a,b)=>a.price-b.price);
      else if (sortKey === 'price-desc') list = list.slice().sort((a,b)=>b.price-a.price);
      else if (sortKey === 'rating-desc') list = list.slice().sort((a,b)=>b.rating-a.rating);
      // 'relevance' default: keep order as-is
      renderCatalog(list);
      // Save last view
      localStorage.setItem(VIEW_KEY, 'catalog');
    }

    // Detail view
    function openDetail(id) {
      const p = getProduct(id);
      if (!p) return;
      detailTitle.textContent = p.name;
      detailImage.src = p.image;
      detailDesc.textContent = p.description;
      detailPrice.textContent = formatCurrency(p.price);
      detailCategory.textContent = p.category;
      detailStock.textContent = p.stock > 0 ? `In stock (${p.stock})` : 'Out of stock';
      detailRating.textContent = 'Rating: ' + p.rating + ' / 5';
      detailAddToCartBtn.disabled = p.stock <= 0;
      detailAddToCartBtn.setAttribute('data-id', p.id);
      detailModal.setAttribute('aria-hidden', 'false');
      persistLastView(id);
    }

    function closeDetail() {
      detailModal.setAttribute('aria-hidden', 'true');
    }

    // Cart rendering
    function renderCart() {
      cartContent.innerHTML = '';
      if (cart.length === 0) {
        cartContent.innerHTML = '<div class="muted" style="padding:8px;">Cart is empty. Add items to continue.</div>';
        cartSubtotalEl.textContent = formatCurrency(0);
        return;
      }
      for (const item of cart) {
        const p = getProduct(item.productId);
        const el = document.createElement('div');
        el.className = 'cart-item';
        el.innerHTML = `
          <img class="cart-thumb" src="${p?.image}" alt="${p?.name}">
          <div>
            <div class="cart-name" style="margin-bottom:4px;">${p?.name}</div>
            <div style="font-size:12px; color:var(--muted);">Unit ${formatCurrency(p?.price || 0)}</div>
          </div>
          <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
            <div class="qty-controls" aria-label="Quantity controls">
              <button data-id="${p?.id}" class="btn" aria-label="Decrease quantity">−</button>
              <span style="min-width:20px; text-align:center;">${item.qty}</span>
              <button data-id="${p?.id}" class="btn" aria-label="Increase quantity">＋</button>
            </div>
            <button class="btn" data-id="${p?.id}" aria-label="Remove item">Remove</button>
          </div>
        `;
        // events
        const decBtn = el.querySelector('button[aria-label="Decrease quantity"]');
        const incBtn = el.querySelectorAll('button')[2]; // Remove button
        const incBtn2 = el.querySelectorAll('button')[3]; // The "Increase" button (alternative if ordering differs)
        // We'll select by inner text
        const allButtons = el.querySelectorAll('button');
        const increaseBtn = Array.from(allButtons).find(b => b.textContent === '＋');
        const decreaseBtn = Array.from(allButtons).find(b => b.textContent === '−');
        const removeBtn = Array.from(allButtons).find(b => b.textContent === 'Remove');
        if (increaseBtn) increaseBtn.addEventListener('click', () => {
          setCartQty(p.id, item.qty + 1);
        });
        if (decreaseBtn) decreaseBtn.addEventListener('click', () => {
          setCartQty(p.id, item.qty - 1);
        });
        if (removeBtn) removeBtn.addEventListener('click', () => removeFromCart(p.id));
        cartContent.appendChild(el);
      }
      cartSubtotalEl.textContent = formatCurrency(cartSubtotal());
    }

    // Checkout flow
    function openCheckout() {
      if (cart.length === 0) {
        alert('Your cart is empty.');
        return;
      }
      checkoutModal.setAttribute('aria-hidden', 'false');
      // Prefill some fields if possible
      document.getElementById('name').value = '';
      document.getElementById('email').value = '';
      document.getElementById('address').value = '';
      document.getElementById('city').value = '';
      document.getElementById('postal').value = '';
      document.getElementById('notes').value = '';
    }

    function closeCheckout() {
      checkoutModal.setAttribute('aria-hidden', 'true');
    }

    function showOrderSuccess(orderId) {
      orderSuccessContent.innerHTML = `
        <h2 style="margin:0 0 8px;">Thank you!</h2>
        <p>Your order <strong>${orderId}</strong> has been placed successfully.</p>
        <p class="muted" style="font-size:12px;">This is a simulated checkout. No payments are processed.</p>
      `;
      orderStatus.setAttribute('aria-hidden', 'false');
    }

    // Init filters UI
    function populateCategories() {
      const cats = Array.from(new Set(products.map(p => p.category)));
      for (const c of cats) {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        categoryFilter.appendChild(opt);
      }
    }

    // Event wiring
    function wireEvents() {
      // Catalog actions
      catalogEl.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-id]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        if (btn.textContent === 'Details') {
          openDetail(id);
        } else {
          addToCart(id, 1);
        }
      });

      // Detail modal controls
      closeDetailBtn.addEventListener('click', closeDetail);
      detailAddToCartBtn.addEventListener('click', () => {
        const pid = detailAddToCartBtn.getAttribute('data-id');
        addToCart(pid, 1);
      });

      // Search and filters
      searchInput.addEventListener('input', applyFilters);
      categoryFilter.addEventListener('change', applyFilters);
      minPriceInput.addEventListener('change', applyFilters);
      maxPriceInput.addEventListener('change', applyFilters);
      minRatingFilter.addEventListener('change', applyFilters);
      sortSelect.addEventListener('change', applyFilters);
      clearFiltersBtn.addEventListener('click', () => {
        categoryFilter.value = 'All';
        minPriceInput.value = 0;
        maxPriceInput.value = 1000;
        minRatingFilter.value = '0';
        sortSelect.value = 'relevance';
        searchInput.value = '';
        applyFilters();
      });

      // Cart drawer
      openCartBtn.addEventListener('click', () => {
        cartDrawer.classList.add('open');
        cartDrawer.setAttribute('aria-hidden', 'false');
        renderCart();
      });
      closeCartBtn.addEventListener('click', () => {
        cartDrawer.classList.remove('open');
        cartDrawer.setAttribute('aria-hidden', 'true');
      });

      // Checkout
      checkoutFromCartBtn.addEventListener('click', () => {
        openCheckout();
      });
      checkoutBtnHeader.addEventListener('click', () => openCheckout());
      closeCheckoutBtn.addEventListener('click', closeCheckout);
      closeCheckoutAltBtn.addEventListener('click', closeCheckout);
      checkoutModal.addEventListener('click', (e) => {
        if (e.target === checkoutModal) closeCheckout();
      });
      closeOrderStatusBtn.addEventListener('click', () => {
        orderStatus.setAttribute('aria-hidden', 'true');
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (detailModal.getAttribute('aria-hidden') === 'false') closeDetail();
          if (cartDrawer.classList.contains('open')) {
            cartDrawer.classList.remove('open');
            cartDrawer.setAttribute('aria-hidden', 'true');
          }
          if (checkoutModal.getAttribute('aria-hidden') === 'false') closeCheckout();
          if (orderStatus.getAttribute('aria-hidden') === 'false') orderStatus.setAttribute('aria-hidden', 'true');
        }
      });

      // Checkout form
      checkoutForm.addEventListener('submit', (ev) => {
        ev.preventDefault();
        // Very light validation
        const name = document.getElementById('name').value.trim();
        const email = document.getElementById('email').value.trim();
        if (!name || !email) {
          alert('Please provide name and email to complete checkout.');
          return;
        }
        // Simulated order-id
        const orderId = 'ORD-' + Math.random().toString(36).slice(2, 8).toUpperCase();
        // Clear cart
        cart = [];
        saveCart();
        renderCart();
        closeCheckout();
        orderStatus.setAttribute('aria-hidden', 'false');
        showOrderSuccess(orderId);
      });

      // OrderStatus close
      closeOrderStatusFromModal.addEventListener('click', () => {
        orderStatus.setAttribute('aria-hidden', 'true');
      });
      closeOrderStatus.addEventListener('click', () => {
        orderStatus.setAttribute('aria-hidden', 'true');
      });

      // Persist last view
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          localStorage.setItem(VIEW_KEY, 'catalog');
        }
      });
    }

    // Init app
    function bootstrap() {
      // Load cart from storage
      loadCart();
      // Populate categories
      populateCategories();
      // Apply initial filters (no user input)
      applyFilters();
      // Restore last view if any
      const lastView = localStorage.getItem(VIEW_KEY);
      if (lastView && lastView.startsWith('p')) {
        // optional: restore a specific product detail
      }
      // Open cart if user requested (not auto)
      // Wire events
      // Delegate events
      wireEvents();
    }

    // Initial render of catalog
    function renderInitialCatalog() {
      renderCatalog();
    }

    // Kickoff
    // Build catalog once on load
    renderInitialCatalog();
    bootstrap();

    // Expose a couple helpers for debugging (optional)
    window.__ShopNest = {
      products,
      getProduct,
      addToCart,
      cart
    };
  </script>
</body>
</html>